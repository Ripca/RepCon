<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pronóstico - Datos Reales</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3a5f 0%, #2c5aa0 100%); color: #333; min-height: 100vh; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: #1e3a5f; color: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .logo { font-size: 24px; font-weight: bold; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; margin: 8px 0; border-radius: 5px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
        .nav-item.active { background: #0066cc; font-weight: bold; }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { color: #1e3a5f; margin-bottom: 10px; }
        .header p { color: #666; font-size: 14px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid #0066cc; }
        .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-card .value { font-size: 28px; font-weight: bold; color: #1e3a5f; }
        .stat-card .icon { float: right; font-size: 40px; color: #0066cc; opacity: 0.2; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .chart-container h2 { color: #1e3a5f; margin-bottom: 20px; font-size: 18px; }
        canvas { max-height: 400px; }
        .controls { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .controls label { font-weight: bold; color: #1e3a5f; }
        .controls select, .controls input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .btn { padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
        .btn:hover { background: #0052a3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,102,204,0.3); }
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0066cc; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page { display: none; }
        .page.active { display: block; }
        .info-box { background: #e3f2fd; border-left: 4px solid #0066cc; padding: 15px; border-radius: 5px; margin-bottom: 20px; color: #1e3a5f; }
        table { width: 100%; border-collapse: collapse; }
        table thead { background: #1e3a5f; color: white; }
        table th { padding: 12px; text-align: left; font-weight: bold; }
        table td { padding: 10px; border-bottom: 1px solid #ddd; }
        table tbody tr:hover { background: #f5f5f5; }
        .dataTables_wrapper { margin-top: 20px; }
        @media (max-width: 768px) { .container { flex-direction: column; } .sidebar { width: 100%; display: flex; gap: 10px; overflow-x: auto; } .nav-item { white-space: nowrap; } .stats-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo"><i class="fas fa-chart-line"></i> Pronóstico</div>
            <div class="nav-item active" onclick="showPage('dashboard')"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-item" onclick="showPage('analysis')"><i class="fas fa-chart-bar"></i> Análisis</div>
            <div class="nav-item" onclick="showPage('forecast')"><i class="fas fa-crystal-ball"></i> Pronósticos</div>
            <div class="nav-item" onclick="showPage('data')"><i class="fas fa-table"></i> Datos</div>
        </div>

        <div class="main-content">
            <div id="dashboard" class="page active">
                <div class="header"><h1><i class="fas fa-home"></i> Dashboard</h1><p>Análisis de predicción con datos reales</p></div>
                <div class="stats-grid" id="statsContainer"><div class="loading"><div class="spinner"></div>Cargando...</div></div>
                <div class="chart-container"><h2><i class="fas fa-chart-line"></i> Tendencia General</h2><canvas id="trendChart"></canvas></div>
                <div class="chart-container"><h2><i class="fas fa-chart-pie"></i> Distribución</h2><canvas id="categoryChart"></canvas></div>
            </div>

            <div id="analysis" class="page">
                <div class="header"><h1><i class="fas fa-chart-bar"></i> Análisis</h1><p>Análisis profundo de categorías</p></div>
                <div class="controls"><label>Categoría:</label><select id="categorySelect" onchange="updateAnalysis()"><option>Seleccionar...</option></select></div>
                <div class="chart-container"><h2>Serie Temporal</h2><canvas id="timeseriesChart"></canvas></div>
                <div class="chart-container"><h2>Estadísticas</h2><div id="statsDetail"></div></div>
            </div>

            <div id="forecast" class="page">
                <div class="header"><h1><i class="fas fa-crystal-ball"></i> Pronósticos</h1><p>Predicciones ARIMA</p></div>
                <div class="controls"><label>Categoría:</label><select id="forecastCategory" onchange="updateForecast()"><option>Seleccionar...</option></select><label>Semanas:</label><input type="number" id="forecastWeeks" value="14" min="1" max="52" onchange="updateForecast()"><button class="btn" onclick="updateForecast()"><i class="fas fa-sync"></i> Actualizar</button></div>
                <div class="chart-container"><h2>Pronóstico ARIMA</h2><canvas id="forecastChart"></canvas></div>
            </div>

            <div id="data" class="page">
                <div class="header"><h1><i class="fas fa-table"></i> Datos</h1><p>Tabla de datos procesados</p></div>
                <div class="info-box"><i class="fas fa-info-circle"></i> Datos agregados por semana de TODOS los archivos (CSV, JSON, XML)</div>
                <div class="chart-container"><div id="dataTable" style="overflow-x: auto;"></div></div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            if (page === 'dashboard') loadDashboard();
            else if (page === 'analysis') loadAnalysis();
            else if (page === 'forecast') loadForecast();
            else if (page === 'data') loadData();
        }
        function loadDashboard() {
            fetch('/api/data/summary').then(r => r.json()).then(data => {
                document.getElementById('statsContainer').innerHTML = `
                    <div class="stat-card"><div class="icon"><i class="fas fa-exchange-alt"></i></div><h3>Transacciones</h3><div class="value">${(data.total_transactions || 0).toLocaleString()}</div></div>
                    <div class="stat-card"><div class="icon"><i class="fas fa-money-bill"></i></div><h3>Monto Total</h3><div class="value">Q ${(data.total_amount || 0).toLocaleString('es-GT', {maximumFractionDigits: 2})}</div></div>
                    <div class="stat-card"><div class="icon"><i class="fas fa-tags"></i></div><h3>Categorías</h3><div class="value">${data.num_categories || 0}</div></div>
                `;
            });
            fetch('/api/data/all-weekly').then(r => r.json()).then(data => {
                const ctx = document.getElementById('trendChart').getContext('2d');
                if (charts.trend) charts.trend.destroy();
                const colors = ['#0066cc', '#ff6b6b', '#51cf66', '#ffd43b', '#a78bfa', '#f472b6', '#06b6d4', '#ec4899', '#8b5cf6', '#14b8a6', '#f97316', '#6366f1', '#ec4899', '#f59e0b'];
                charts.trend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: Object.keys(data).filter(k => k !== 'dates').map((cat, i) => ({
                            label: cat,
                            data: data[cat],
                            borderColor: colors[i % colors.length],
                            tension: 0.4,
                            fill: false,
                            borderWidth: 2
                        }))
                    },
                    options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'top' } } }
                });
            });
            // Gráfico de distribución por categoría
            fetch('/api/data/all-weekly').then(r => r.json()).then(data => {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                if (charts.category) charts.category.destroy();
                const categories = Object.keys(data).filter(k => k !== 'dates');
                const totals = categories.map(cat => data[cat].reduce((a, b) => a + b, 0));
                const colors = ['#0066cc', '#ff6b6b', '#51cf66', '#ffd43b', '#a78bfa', '#f472b6', '#06b6d4', '#ec4899', '#8b5cf6', '#14b8a6', '#f97316', '#6366f1', '#ec4899', '#f59e0b'];
                charts.category = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: totals,
                            backgroundColor: colors.slice(0, categories.length)
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'right' } } }
                });
            });
        }
        function loadAnalysis() {
            fetch('/api/data/categories').then(r => r.json()).then(data => {
                const select = document.getElementById('categorySelect');
                select.innerHTML = '<option>Seleccionar...</option>' + data.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            });
        }
        function updateAnalysis() {
            const cat = document.getElementById('categorySelect').value;
            if (!cat || cat === 'Seleccionar...') return;
            fetch(`/api/data/weekly/${cat}`).then(r => r.json()).then(data => {
                const ctx = document.getElementById('timeseriesChart').getContext('2d');
                if (charts.timeseries) charts.timeseries.destroy();
                charts.timeseries = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: data.dates, datasets: [{ label: cat, data: data.values, backgroundColor: '#0066cc' }] },
                    options: { responsive: true, maintainAspectRatio: true }
                });
                const stats = data.statistics;
                document.getElementById('statsDetail').innerHTML = `
                    <table style="width:100%; border-collapse: collapse;">
                        <tr><td style="padding:10px; border-bottom:1px solid #ddd;"><strong>Media:</strong></td><td>Q ${(stats.mean || 0).toLocaleString()}</td></tr>
                        <tr><td style="padding:10px; border-bottom:1px solid #ddd;"><strong>Desv. Est.:</strong></td><td>Q ${(stats.std || 0).toLocaleString()}</td></tr>
                        <tr><td style="padding:10px; border-bottom:1px solid #ddd;"><strong>Mínimo:</strong></td><td>Q ${(stats.min || 0).toLocaleString()}</td></tr>
                        <tr><td style="padding:10px; border-bottom:1px solid #ddd;"><strong>Máximo:</strong></td><td>Q ${(stats.max || 0).toLocaleString()}</td></tr>
                        <tr><td style="padding:10px;"><strong>Total:</strong></td><td>Q ${(stats.total || 0).toLocaleString()}</td></tr>
                    </table>
                `;
            });
        }
        function loadForecast() {
            fetch('/api/data/categories').then(r => r.json()).then(data => {
                const select = document.getElementById('forecastCategory');
                select.innerHTML = '<option>Seleccionar...</option>' + data.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            });
        }
        function updateForecast() {
            const cat = document.getElementById('forecastCategory').value;
            const weeks = document.getElementById('forecastWeeks').value;
            if (!cat || cat === 'Seleccionar...') return;
            fetch('/api/forecast', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ category: cat, weeks: parseInt(weeks) }) })
            .then(r => r.json()).then(data => {
                const ctx = document.getElementById('forecastChart').getContext('2d');
                if (charts.forecast) charts.forecast.destroy();
                charts.forecast = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [...data.historical_dates, ...data.forecast_dates],
                        datasets: [
                            { label: 'Histórico', data: [...data.historical_values, null], borderColor: '#0066cc', fill: false },
                            { label: 'Pronóstico', data: [null, ...data.forecast_values], borderColor: '#ff6b6b', borderDash: [5, 5], fill: false }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: true }
                });
            });
        }
        function loadData() {
            fetch('/api/data/all-weekly').then(r => r.json()).then(data => {
                const categories = Object.keys(data).filter(k => k !== 'dates');
                let html = '<table id="dataTableElement" class="display" style="width:100%;"><thead><tr><th>Fecha</th>';
                categories.forEach(cat => { html += `<th>${cat}</th>`; });
                html += '</tr></thead><tbody>';
                data.dates.forEach((date, i) => {
                    html += `<tr><td>${date}</td>`;
                    categories.forEach(cat => { html += `<td>Q ${(data[cat][i] || 0).toLocaleString('es-GT', {maximumFractionDigits: 2})}</td>`; });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                document.getElementById('dataTable').innerHTML = html;
                // Inicializar DataTable
                if ($.fn.dataTable.isDataTable('#dataTableElement')) {
                    $('#dataTableElement').DataTable().destroy();
                }
                $('#dataTableElement').DataTable({
                    paging: true,
                    searching: true,
                    ordering: true,
                    info: true,
                    pageLength: 10,
                    scrollX: true,
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                    }
                });
            });
        }
        window.addEventListener('load', loadDashboard);
    </script>
</body>
</html>
